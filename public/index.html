<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Temp (last hour)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase (compat style for simplicity in small pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width:900px; margin:20px auto; padding:0 12px; }
    h1 { font-size:1.3rem; }
    #current { font-size: 1.1rem; margin-bottom: 12px; }
    canvas { background: #fff; border: 1px solid #eee; padding: 6px; }
  </style>
</head>
<body>
  <h1>Temperature — current & last hour (1/min)</h1>
  <div id="current">Current: <span id="curVal">--</span> °C</div>
  <canvas id="chart" width="800" height="320"></canvas>

  <script>
    // TODO: replace with your Firebase config from console (web app) OR use databaseURL
    const firebaseConfig = {
      apiKey: "AIzaSyAaWycGwWQlpIAnIGK46fEyXKzAvPDIFLY",
      authDomain: "tempds18b20-9bb40.firebaseapp.com",
      databaseURL: "https://tempds18b20-9bb40-default-rtdb.firebaseio.com",
      projectId: "tempds18b20-9bb40",
      storageBucket: "tempds18b20-9bb40.firebasestorage.app",
      messagingSenderId: "774803511429",
      appId: "1:774803511429:web:af51407c49386062a871ec"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Chart.js setup
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], // timestamps formatted
        datasets: [{
          label: 'Temperature (°C)',
          data: [],
          fill: false,
          tension: 0.25,
          pointRadius: 2
        }]
      },
      options: {
        animation: false,
        scales: {
          x: { display: true, title: { display: true, text: 'Time' } },
          y: { display: true, title: { display: true, text: '°C' } }
        }
      }
    });

    const curEl = document.getElementById('curVal');

    // query last 60 samples and listen for changes
    function fetchAndListen() {
      const q = db.ref('temperatures').orderByChild('t').limitToLast(60);
      // initial and subsequent updates
      q.on('value', snapshot => {
        const arr = [];
        snapshot.forEach(child => {
          const v = child.val();
          if (v && v.t && v.v !== undefined) arr.push({ t: v.t, v: v.v });
        });
        // sort by timestamp asc
        arr.sort((a,b)=>a.t - b.t);
        const labels = arr.map(item => {
          const d = new Date(item.t);
          return d.toLocaleTimeString();
        });
        const data = arr.map(item => item.v);
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();

        if (arr.length > 0) {
          const last = arr[arr.length - 1];
          curEl.textContent = last.v.toFixed(2);
        } else {
          curEl.textContent = '--';
        }
      });
    }

    fetchAndListen();
  </script>
</body>
</html>
